From f5f36ac5649c37220f12d30ef5eae465b0582e68 Mon Sep 17 00:00:00 2001
From: Deepak Rathore <deepak.rathore@einfochips.com>
Date: Thu, 5 Jan 2023 15:21:22 +0530
Subject: [PATCH 2/3] IMX8MQ: Added AR0830 camera sensor support

- Added AR0830 Camera sensor support
- Added AR0830 sensor details in ap1302 driver

Change-Id: Ia682ce59e75069f9f19259b682382fde8c50d5ce
Signed-off-by: Deepak Rathore <deepak.rathore@einfochips.com>
---
 arch/arm64/boot/dts/freescale/Makefile        |  2 +-
 .../freescale/imx8mq-thor96-ap1302-ar0830.dts | 67 +++++++++++++++++++
 drivers/media/i2c/ap1302.c                    | 15 +++++
 3 files changed, 83 insertions(+), 1 deletion(-)
 create mode 100644 arch/arm64/boot/dts/freescale/imx8mq-thor96-ap1302-ar0830.dts

diff --git a/arch/arm64/boot/dts/freescale/Makefile b/arch/arm64/boot/dts/freescale/Makefile
index 92d5cf431..baeb81ac2 100644
--- a/arch/arm64/boot/dts/freescale/Makefile
+++ b/arch/arm64/boot/dts/freescale/Makefile
@@ -124,7 +124,7 @@ dtb-$(CONFIG_ARCH_MXC) += imx8mq-phanbell.dtb
 dtb-$(CONFIG_ARCH_MXC) += imx8mq-pico-pi.dtb
 dtb-$(CONFIG_ARCH_MXC) += imx8mq-thor96.dtb imx8mq-thor96-dual-display.dtb imx8mq-thor96-dcss-rm67191.dtb \
 			  imx8mq-thor96-lcdif-adv7535.dtb imx8mq-thor96-ap1302-ar0430.dtb imx8mq-thor96-ap1302-arx3a0.dtb \
-			  imx8mq-thor96-ap1302-ar1335.dtb
+			  imx8mq-thor96-ap1302-ar1335.dtb imx8mq-thor96-ap1302-ar0830.dtb
 dtb-$(CONFIG_ARCH_MXC) += imx8mq-evk-dp.dtb
 dtb-$(CONFIG_ARCH_MXC) += imx8mq-zii-ultra-rmb3.dtb
 dtb-$(CONFIG_ARCH_MXC) += imx8mq-zii-ultra-zest.dtb
diff --git a/arch/arm64/boot/dts/freescale/imx8mq-thor96-ap1302-ar0830.dts b/arch/arm64/boot/dts/freescale/imx8mq-thor96-ap1302-ar0830.dts
new file mode 100644
index 000000000..083c12499
--- /dev/null
+++ b/arch/arm64/boot/dts/freescale/imx8mq-thor96-ap1302-ar0830.dts
@@ -0,0 +1,67 @@
+// SPDX-License-Identifier: GPL-2.0
+/*
+ * Copyright 2019 NXP.
+ */
+
+#include "imx8mq-thor96.dts"
+
+&ov5640_mipi2 {
+	status = "disabled";
+};
+
+&ov5640_mipi {
+	status = "disabled";
+};
+
+&i2c3 {
+	ap1302_mipi: ap1302@3d {
+		compatible = "onnn,ap1302";
+		reg = <0x3d>;
+
+		pinctrl-0 = <&pinctrl_csi>;
+		clocks = <&clk IMX8MQ_CLK_CLKO2>;
+		clock-names = "xclk";
+		assigned-clocks = <&clk IMX8MQ_CLK_CLKO2>,
+				  <&clk IMX8MQ_CLK_CLKO2>;
+		assigned-clock-parents = <&clk IMX8MQ_SYS2_PLL_200M>;
+		assigned-clock-rates = <0>, <20000000>;
+
+		reset-gpios = <&gpio3 24 GPIO_ACTIVE_LOW>;
+		standby-gpios = <&gpio2 7 GPIO_ACTIVE_HIGH>;
+		i2csel-gpios = <&gpio2 8 GPIO_ACTIVE_HIGH>;
+		isptrig-gpios = <&gpio3 12 GPIO_ACTIVE_HIGH>;
+		status = "okay";
+
+		port {
+			ap1302_ep: endpoint {
+				remote-endpoint = <&mipi1_sensor_ep>;
+				data-lanes = <1 2 3 4>;
+			};
+		};
+
+		sensors {
+			#address-cells = <1>;
+			#size-cells = <0>;
+			onnn,model = "onnn,ar0830";
+			sensor@0 {
+				reg = <0>;
+			};
+		};
+	};
+};
+
+&mipi1_sensor_ep {
+	remote-endpoint = <&ap1302_ep>;
+	data-lanes = <1 2 3 4>;
+	csis-wclk;
+};
+
+&iomuxc {
+	pinctrl_csi: csi_grp {
+		fsl,pins = <
+			MX8MQ_IOMUXC_SD1_DATA5_GPIO2_IO7	0x19
+			MX8MQ_IOMUXC_SAI5_RXD3_GPIO3_IO24	0x19
+			MX8MQ_IOMUXC_GPIO1_IO15_CCMSRCGPCMIX_CLKO2      0x59
+		>;
+	};
+};
diff --git a/drivers/media/i2c/ap1302.c b/drivers/media/i2c/ap1302.c
index 245b0ee1f..b9b6d9bb1 100644
--- a/drivers/media/i2c/ap1302.c
+++ b/drivers/media/i2c/ap1302.c
@@ -29,6 +29,7 @@
 #define DRIVER_NAME "ap1302"
 
 #define AR0430_MODEL   "onnn,ar0430"
+#define AR0830_MODEL   "onnn,ar0830"
 #define AR1335_MODEL   "onnn,ar1335"
 
 #define AP1302_FW_WINDOW_SIZE			0x2000
@@ -604,6 +605,20 @@ static const struct ap1302_sensor_info ap1302_sensor_info[] = {
 			{ "vddio", 0 },
 			{ NULL, 0 },
 		},
+	}, {
+                .model = "onnn,ar0830",
+                .name = "ar0830",
+                .i2c_addr = 0x36,
+                .resolution = { 3840, 2160 },
+                .fps = 30,
+                .format = MEDIA_BUS_FMT_UYVY8_2X8,
+                .supplies = (const struct ap1302_sensor_supply[]) {
+                        { "vddpll", 0 },
+                        { "vaa", 0 },
+                        { "vdd", 0 },
+                        { "vddio", 0 },
+                        { NULL, 0 },
+                },
 	}
 };
 
-- 
2.17.1

